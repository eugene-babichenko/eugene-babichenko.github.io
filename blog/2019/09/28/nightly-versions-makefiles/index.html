<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="index, follow" name=robots><link href=https://eugene-babichenko.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><title>Eugene Babichenko | Generating pretty version strings (including nightly) with Git and Makefiles</title><link as=style href=https://eugene-babichenko.github.io/css/style.css rel=preload><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/reset-min.css rel=stylesheet><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/suCSS-min.css rel=stylesheet><link href=https://eugene-babichenko.github.io/css/style.css rel=stylesheet><link href=https://eugene-babichenko.github.io/css/custom.css rel=stylesheet><link href=https://eugene-babichenko.github.io/favicon.ico rel=icon><body><nav id=nav-bar><a href=/> /home/ </a><a href=/blog> /blog/ </a><a href=https://github.com/eugene-babichenko> /github/ </a><a href=https://standwithukraine.com.ua/> /ðŸ‡ºðŸ‡¦ Support Ukraine/ </a><div aria-label="Toggle theme" class=theme-toggle data-icon-base=https://eugene-babichenko.github.io/icons.svg data-icon-dark=#darkMode data-icon-light=#lightMode data-sound-src=https://eugene-babichenko.github.io/click.ogg id=theme-toggle role=button tabindex=0><svg class=icon><use id=theme-icon></use></svg></div></nav><main><article class=post><header class=post-header><time datetime=2019-09-28T16:45:00+03:00>Published on: <span class=accent-data>2019-09-28</span> </time><h1>Generating pretty version strings (including nightly) with Git and Makefiles</h1></header><div class=post-content><p>In my recent project, I faced the need to generate pretty version numbers for my local and nightly builds. Here I will describe the approach I came up with. In this tutorial, we will use Git, which stores version tags and the entire setup uses Makefiles. However, you should be able to adapt this approach to any build system.<p>In the end, we will be able to get pretty and very informative version strings like <code>0.2.1-next-314da12-20190928</code>.<p>You can check out the code from this article in <a href=https://gist.github.com/eugene-babichenko/f37d15626160914427563dff2edd57ed>this Gist</a>.<p>First of all, we need to have versions based on git tags. Here, I will assume that version tags are in the format <code>v0.1.2</code>. Given that, we can extract the latest tag and strip the <code>v</code>:<pre class=language-makefile data-lang=makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-makefile data-lang=makefile><span style=color:#bf616a>TAG_COMMIT </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> rev-list</span><span style=color:#bf616a> --abbrev-commit --tags --max-count</span><span>=</span><span style=color:#a3be8c>1</span><span style=color:#b48ead>)
</span><span style=color:#65737e># `2>/dev/null` suppress errors and `|| true` suppress the error codes.
</span><span style=color:#bf616a>TAG </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> describe</span><span style=color:#bf616a> --abbrev</span><span>=</span><span style=color:#a3be8c>0</span><span style=color:#bf616a> --tags </span><span style=color:#b48ead>${</span><span style=color:#bf616a>TAG_COMMIT</span><span style=color:#b48ead>} </span><span style=color:#d08770>2</span><span>></span><span style=color:#a3be8c>/dev/null </span><span>|| </span><span style=color:#bf616a>true</span><span style=color:#b48ead>)
</span><span style=color:#65737e># here we strip the version prefix
</span><span style=color:#bf616a>VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>TAG:v%=%</span><span style=color:#b48ead>)
</span></code></pre><p>This script will not fail if there are no tags in the current repository, but this will generate an empty version string. In this case, we can build a version string from the latest git commit hash and add the commit date for additional info:<pre class=language-makefile data-lang=makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-makefile data-lang=makefile><span style=color:#65737e># get the latest commit hash in the short form
</span><span style=color:#bf616a>COMMIT </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> rev-parse</span><span style=color:#bf616a> --short</span><span style=color:#a3be8c> HEAD</span><span style=color:#b48ead>)
</span><span style=color:#65737e># get the latest commit date in the form of YYYYmmdd
</span><span style=color:#bf616a>DATE </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> log</span><span style=color:#bf616a> -1 --format</span><span>=%</span><span style=color:#bf616a>cd --date</span><span>=</span><span style=color:#a3be8c>format:</span><span>"</span><span style=color:#a3be8c>%Y%m%d</span><span>"</span><span style=color:#b48ead>)
</span><span style=color:#65737e># check if the version string is empty
</span><span style=color:#b48ead>ifeq</span><span> $(VERSION,)
</span><span style=color:#bf616a>	VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>COMMIT</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>DATA</span><span style=color:#b48ead>)
</span><span style=color:#b48ead>endif
</span></code></pre><p>This will give us a version string in a format like <code>314da12-20190928</code> which gives us pretty much information about the build. Particularly, when the change was made and which commit we should look for.<p>On top of that, we can deal with nightly builds that appeared after a particular version like that: <code>0.2.1-next-314da12-20190928</code>. This line contains even more information as it includes the last stable version. We can quickly grab the version number and compare our changes to it to see what went wrong. This is how we generate this:<pre class=language-makefile data-lang=makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-makefile data-lang=makefile><span style=color:#b48ead>ifneq </span><span>(</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>COMMIT</span><span style=color:#b48ead>)</span><span>, </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>TAG_COMMIT</span><span style=color:#b48ead>)</span><span>)
</span><span style=color:#bf616a>	VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>VERSION</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-next-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>COMMIT</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>DATE</span><span style=color:#b48ead>)
</span><span style=color:#b48ead>endif
</span></code></pre><p>Finally, we can indicate that we were building from a dirty git state (e.g. we had uncommitted changes during the build):<pre class=language-makefile data-lang=makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-makefile data-lang=makefile><span style=color:#65737e># git status --porcelain outputs a machine-readable text and the output is empty
</span><span style=color:#65737e># if the working tree is clean
</span><span style=color:#b48ead>ifneq </span><span>(</span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span> status</span><span style=color:#bf616a> --porcelain</span><span style=color:#b48ead>)</span><span>,)
</span><span style=color:#bf616a>	VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>VERSION</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-dirty
</span><span style=color:#b48ead>endif
</span></code></pre><p>This is how the script looks in the end:<pre class=language-makefile data-lang=makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-makefile data-lang=makefile><span style=color:#bf616a>TAG_COMMIT </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> rev-list</span><span style=color:#bf616a> --abbrev-commit --tags --max-count</span><span>=</span><span style=color:#a3be8c>1</span><span style=color:#b48ead>)
</span><span style=color:#bf616a>TAG </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> describe</span><span style=color:#bf616a> --abbrev</span><span>=</span><span style=color:#a3be8c>0</span><span style=color:#bf616a> --tags </span><span style=color:#b48ead>${</span><span style=color:#bf616a>TAG_COMMIT</span><span style=color:#b48ead>} </span><span style=color:#d08770>2</span><span>></span><span style=color:#a3be8c>/dev/null </span><span>|| </span><span style=color:#bf616a>true</span><span style=color:#b48ead>)
</span><span style=color:#bf616a>COMMIT </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> rev-parse</span><span style=color:#bf616a> --short</span><span style=color:#a3be8c> HEAD</span><span style=color:#b48ead>)
</span><span style=color:#bf616a>DATE </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span style=color:#a3be8c> log</span><span style=color:#bf616a> -1 --format</span><span>=%</span><span style=color:#bf616a>cd --date</span><span>=</span><span style=color:#a3be8c>format:</span><span>"</span><span style=color:#a3be8c>%Y%m%d</span><span>"</span><span style=color:#b48ead>)
</span><span style=color:#bf616a>VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>TAG:v%=%</span><span style=color:#b48ead>)
</span><span style=color:#b48ead>ifneq </span><span>(</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>COMMIT</span><span style=color:#b48ead>)</span><span>, </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>TAG_COMMIT</span><span style=color:#b48ead>)</span><span>)
</span><span style=color:#bf616a>	VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>VERSION</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-next-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>COMMIT</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>DATE</span><span style=color:#b48ead>)
</span><span style=color:#b48ead>endif
</span><span style=color:#b48ead>ifeq</span><span> $(VERSION,)
</span><span style=color:#bf616a>	VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>COMMIT</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>DATA</span><span style=color:#b48ead>)
</span><span style=color:#b48ead>endif
</span><span style=color:#b48ead>ifneq </span><span>(</span><span style=color:#b48ead>$(</span><span style=color:#96b5b4>shell </span><span style=color:#bf616a>git</span><span> status</span><span style=color:#bf616a> --porcelain</span><span style=color:#b48ead>)</span><span>,)
</span><span style=color:#bf616a>	VERSION </span><span>:= </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>VERSION</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>-dirty
</span><span style=color:#b48ead>endif
</span></code></pre><p>That's all! For me, this looks very good, because it does not use any additional tools apart from Git and <code>make</code>. Hope you will find this useful!<p>As a bonus, I would like to show how I integrate that with Go builds.<p>First, you need to specify the <code>version</code> variable in your <code>main</code> package (I do it exactly this way because this is compatible with GoReleaser):<pre class=language-go data-lang=go style=color:#c0c5ce;background-color:#2b303b><code class=language-go data-lang=go><span style=color:#b48ead>package </span><span style=color:#bf616a>main
</span><span>
</span><span style=color:#b48ead>import </span><span>(
</span><span>	</span><span style=color:#65737e>// ...
</span><span>)
</span><span>
</span><span style=color:#b48ead>var </span><span style=color:#bf616a>version </span><span>= "</span><span style=color:#a3be8c>dev</span><span>"
</span><span>
</span><span style=color:#b48ead>func </span><span style=color:#8fa1b3>main</span><span>() {
</span><span>	</span><span style=color:#65737e>// ...
</span><span>}
</span></code></pre><p>And this is my <code>Makefile</code> for filling in that variable<pre class=language-makefile data-lang=makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-makefile data-lang=makefile><span style=color:#bf616a>FLAGS </span><span>:= </span><span style=color:#a3be8c>-ldflags "-X main.version=</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>VERSION</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>"
</span><span>
</span><span style=color:#8fa1b3>build</span><span>:
</span><span>	</span><span style=color:#bf616a>go</span><span> build </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>FLAGS</span><span style=color:#b48ead>)</span><span style=color:#bf616a> -o</span><span> projectname-</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>VERSION</span><span style=color:#b48ead>)</span><span> main.go
</span><span>
</span><span style=color:#8fa1b3>run</span><span>:
</span><span>	</span><span style=color:#bf616a>go</span><span> run </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>FLAGS</span><span style=color:#b48ead>)</span><span> main.go
</span><span>
</span><span style=color:#8fa1b3>install</span><span>:
</span><span>	</span><span style=color:#bf616a>go</span><span> install </span><span style=color:#b48ead>$(</span><span style=color:#bf616a>FLAGS</span><span style=color:#b48ead>)
</span></code></pre></div></article></main><footer><hr><div id=footer-container><p>Made using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> Zola theme.<p><a title="face icons" href=https://www.flaticon.com/free-icons/face>Face icons created by Freepik - Flaticon</a><p>Â© 2018-2025 Eugene Babichenko</div></footer><script defer src=https://eugene-babichenko.github.io/js/script.js></script>