<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="index, follow" name=robots><link href=https://eugene-babichenko.github.io/rss.xml rel=alternate title=RSS type=application/rss+xml><title>Eugene Babichenko | Setting up pre-commit git hook to check Rust code formatting</title><link as=style href=https://eugene-babichenko.github.io/css/style.css rel=preload><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/reset-min.css rel=stylesheet><link crossorigin href=https://raw.githack.com/Speyll/suCSS/main/suCSS-min.css rel=stylesheet><link href=https://eugene-babichenko.github.io/css/style.css rel=stylesheet><link href=https://eugene-babichenko.github.io/css/custom.css rel=stylesheet><link href=https://eugene-babichenko.github.io/favicon.ico rel=icon><body><nav id=nav-bar><a href=/> /home/ </a><a href=/blog> /blog/ </a><a href=https://github.com/eugene-babichenko> /github/ </a><a href=https://standwithukraine.com.ua/> /üá∫üá¶ Support Ukraine/ </a><div aria-label="Toggle theme" class=theme-toggle data-icon-base=https://eugene-babichenko.github.io/icons.svg data-icon-dark=#darkMode data-icon-light=#lightMode data-sound-src=https://eugene-babichenko.github.io/click.ogg id=theme-toggle role=button tabindex=0><svg class=icon><use id=theme-icon></use></svg></div></nav><main><article class=post><header class=post-header><time datetime=2018-11-08T17:05:00+03:00>Published on: <span class=accent-data>2018-11-08</span> </time><h1>Setting up pre-commit git hook to check Rust code formatting</h1></header><div class=post-content><p>The whole thing this article is about is pretty common. But it might save you some time when you set up a Rust repository. Quick recap: git hooks are scripts that are triggered by git on certain actions. Here we are interested in the pre-commit hook which is fired before you enter the commit message. We will use it to check the code style with <code>rustfmt</code> which you need to install first: <code>cargo install rustfmt</code>. Try running it with the following command: <code>cargo fmt -- --force --write-mode diff</code>. This will output the suggested patch to fix your codestyle. In-place fixes can be performed with the <code>cargo fmt -- --force --write-mode overwrite</code> command.<p><a href=https://gist.github.com/eugene-babichenko/ca9645fa8b579b9c56668f7b0eb74095>Github Gist with the materials of this tutorial</a><h2 id=writing-the-hook>Writing the hook</h2><p>So let's wrap it in a simple bash script that will check files staged for commit:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#65737e>#!/bin/bash
</span><span>
</span><span style=color:#bf616a>HAS_ISSUES</span><span>=</span><span style=color:#a3be8c>0
</span><span style=color:#bf616a>FIRST_FILE</span><span>=</span><span style=color:#a3be8c>1
</span><span>
</span><span style=color:#b48ead>for</span><span> file </span><span style=color:#b48ead>in </span><span>$(</span><span style=color:#bf616a>git</span><span> diff</span><span style=color:#bf616a> --name-only --staged</span><span>); </span><span style=color:#b48ead>do
</span><span>    </span><span style=color:#bf616a>FMT_RESULT</span><span>="$</span><span style=color:#a3be8c>(</span><span style=color:#bf616a>rustfmt --skip-children --force --write-mode</span><span style=color:#a3be8c> diff </span><span>$</span><span style=color:#bf616a>file </span><span style=color:#d08770>2</span><span>></span><span style=color:#a3be8c>/dev/null </span><span>|| </span><span style=color:#bf616a>true</span><span style=color:#a3be8c>)</span><span>"
</span><span>    </span><span style=color:#b48ead>if </span><span style=color:#96b5b4>[ </span><span>"$</span><span style=color:#bf616a>FMT_RESULT</span><span>" != "" </span><span style=color:#96b5b4>]</span><span>; </span><span style=color:#b48ead>then
</span><span>        </span><span style=color:#b48ead>if </span><span style=color:#96b5b4>[ </span><span>$</span><span style=color:#bf616a>FIRST_FILE -eq</span><span> 0 </span><span style=color:#96b5b4>]</span><span>; </span><span style=color:#b48ead>then
</span><span>            </span><span style=color:#96b5b4>echo </span><span style=color:#bf616a>-n </span><span>"</span><span style=color:#a3be8c>, </span><span>"
</span><span>        </span><span style=color:#b48ead>fi
</span><span>        </span><span style=color:#96b5b4>echo </span><span style=color:#bf616a>-n </span><span>"$</span><span style=color:#bf616a>file</span><span>"
</span><span>        </span><span style=color:#bf616a>HAS_ISSUES</span><span>=</span><span style=color:#a3be8c>1
</span><span>        </span><span style=color:#bf616a>FIRST_FILE</span><span>=</span><span style=color:#a3be8c>0
</span><span>    </span><span style=color:#b48ead>fi
</span><span style=color:#b48ead>done
</span><span>
</span><span style=color:#b48ead>if </span><span style=color:#96b5b4>[ </span><span>$</span><span style=color:#bf616a>HAS_ISSUES -eq</span><span> 0 </span><span style=color:#96b5b4>]</span><span>; </span><span style=color:#b48ead>then
</span><span>    </span><span style=color:#96b5b4>exit</span><span> 0
</span><span style=color:#b48ead>fi
</span><span>
</span><span style=color:#96b5b4>echo </span><span>"</span><span style=color:#a3be8c>. Your code has formatting issues in files listed above. Format your code with </span><span style=color:#96b5b4>\`</span><span style=color:#a3be8c>make format</span><span style=color:#96b5b4>\`</span><span style=color:#a3be8c> or call rustfmt manually.</span><span>"
</span><span style=color:#96b5b4>exit</span><span> 1
</span></code></pre><p>Explanation:<ul><li><code>git diff --name-only --staged</code> gather names of staged files;<li><code>rustfmt --skip-children --force --write-mode diff $file 2>/dev/null || true</code> does the check magic: <ul><li><code>--skip-children</code> -- this flag is required to not check submodules of a module. This is here because those files may be uncommitted but cause the check to fail.<li><code>--force</code> -- just a bypass for the warning that suggests installing the nightly version of <code>rustfmt</code>.<li><code>--write-mode diff</code> -- we check that the diff is empty which actually means that the code style is OK.<li><code>2>/dev/null || true</code> -- <code>rustfmt</code> signalizes that it cannot format some lines (for example, very long constant strings) with error messages. With that, we suppress error messages and make the command to exit with 0. That might not be a very good practice but it works for me. Actually, long strings were the only problem.</ul></ul><p>The rest of the script is pretty trivial and is all about pretty-printing the result of the check.<h2 id=putting-it-to-work>Putting it to work</h2><p>When working with got hooks you need to keep in mind that you need to share them. My approach is to create the folder called <code>.githooks</code> and put all scripts into it. For example, the above script is saved under the name <code>pre-commit</code>. Don't forget to make it executable!<p>To make git see hooks in <code>.githooks</code> run <code>git config core.hooksPath .githooks</code>. I put this command to my <code>Makefile</code> to make it runnable with <code>make init</code>. I also put a script under <code>make format</code> to quickly fix everything.<h2 id=final-result>Final result</h2><p>Now if you have any formatting issues git will let you know!<pre style=color:#c0c5ce;background-color:#2b303b><code><span>‚ùØ git commit
</span><span>build.rs, src/main.rs. Your code has formatting issues in files listed above.
</span><span>Format your code with `make format` or call rustfmt manually.
</span></code></pre><p>You can also slightly modify this script by using <code>git diff --name-only HEAD~1 HEAD</code> to fetch the list of files to perform code style check on your CI system.</div></article></main><footer><hr><div id=footer-container><p>Made using <a rel="noopener noreferrer" href=https://github.com/Speyll/anemone target=_blank>anemone</a> Zola theme.<p><a title="face icons" href=https://www.flaticon.com/free-icons/face>Face icons created by Freepik - Flaticon</a><p>¬© 2018-2025 Eugene Babichenko</div></footer><script defer src=https://eugene-babichenko.github.io/js/script.js></script>